<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sadhana Yoga Retreat - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --dark-green: #506C4A;
            --light-green: #8DA399;
            --gold: #C9A96E;
            --text-color: #192812;
            --background: #F4F1EC;
            --light-accent: #E8E4D9;
            --white: #FFFFFF;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(80, 108, 74, 0.08);
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            line-height: 1.6;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            color: var(--dark-green);
            margin-bottom: 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--dark-green) 0%, #3e553c 100%);
            color: white;
            border-radius: var(--border-radius);
        }

        .header h1 {
            color: white;
        }

        .section {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--dark-green);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background-color: #3e553c;
        }

        .logout-btn {
            background-color: transparent;
            color: var(--dark-green);
            border: 2px solid var(--dark-green);
        }

        .logout-btn:hover {
            background-color: rgba(80, 108, 74, 0.1);
        }

        .danger-btn {
            background-color: var(--danger);
        }

        .danger-btn:hover {
            background-color: #d32f2f;
        }

        .success-btn {
            background-color: var(--success);
        }

        .success-btn:hover {
            background-color: #2e8b47;
        }

        .warning-btn {
            background-color: var(--warning);
        }

        .warning-btn:hover {
            background-color: #e68900;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--dark-green);
        }

        .dashboard-card h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: var(--dark-green);
        }

        .dashboard-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-green);
        }

        .table-wrap {
            overflow-x: auto;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            min-width: 700px;
        }

        th, td {
            border: 1px solid var(--light-accent);
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: var(--dark-green);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        tr:nth-child(even) {
            background-color: rgba(244, 241, 236, 0.5);
        }

        tr:hover {
            background-color: rgba(80, 108, 74, 0.05);
        }

        .search-container {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }

        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--light-accent);
            border-radius: var(--border-radius);
        }

        .whatsapp-link {
            color: #1a73e8;
            text-decoration: underline;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--dark-green);
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #d32f2f;
            background: rgba(211, 47, 47, 0.1);
            border-radius: var(--border-radius);
        }

        /* Date Blocker Widget Styles */
        .date-blocker-toggle {
            background: var(--gold);
            color: var(--text-color);
        }

        .date-blocker-widget {
            display: none;
            background: var(--white);
            border: 2px solid var(--light-green);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }

        .date-blocker-widget.active {
            display: block;
        }

        .date-blocker-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-green);
        }

        .form-group input {
            padding: 10px;
            border: 1px solid var(--light-accent);
            border-radius: var(--border-radius);
        }

        .blocked-dates-table {
            margin-top: 20px;
        }

        .action-cell {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: var(--warning);
            color: white;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--success);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--danger);
        }

        .edit-form {
            display: none;
            background: var(--light-accent);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
        }

        .edit-form.active {
            display: block;
        }

        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            .date-blocker-form {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sadhana Yoga Retreat</h1>
        <p>Admin Dashboard</p>
    </div>

    <div class="section">
        <div class="admin-header">
            <h2>Admin Dashboard</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="window.location.href='index.html'">
                    <i class="fas fa-arrow-left"></i>Back to Booking
                </button>
                <button class="date-blocker-toggle" onclick="toggleDateBlocker()">
                    <i class="fas fa-calendar-times"></i>Date Blocker
                </button>
                <button onclick="loadAdminData()">
                    <i class="fas fa-sync-alt"></i>Refresh Data
                </button>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>Logout
                </button>
            </div>
        </div>

        <!-- Date Blocker Widget -->
        <div class="date-blocker-widget" id="dateBlockerWidget">
            <h3><i class="fas fa-ban"></i> Block Date Ranges</h3>
            
            <!-- Add Block Form -->
            <div class="date-blocker-form">
                <div class="form-group">
                    <label for="start">Start Date</label>
                    <input type="date" id="start">
                </div>
                <div class="form-group">
                    <label for="end">End Date</label>
                    <input type="date" id="end">
                </div>
                <div class="form-group">
                    <label for="reason">Reason for Blocking</label>
                    <input type="text" id="reason" placeholder="E.g., Maintenance, Holiday, etc.">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="success-btn" onclick="addBlock()">
                        <i class="fas fa-ban"></i> Block Dates
                    </button>
                </div>
            </div>

            <!-- Edit Block Form (Hidden by default) -->
            <div class="edit-form" id="editForm">
                <h4><i class="fas fa-edit"></i> Edit Block</h4>
                <div class="date-blocker-form">
                    <input type="hidden" id="edit_id">
                    <div class="form-group">
                        <label for="edit_start">Start Date</label>
                        <input type="date" id="edit_start">
                    </div>
                    <div class="form-group">
                        <label for="edit_end">End Date</label>
                        <input type="date" id="edit_end">
                    </div>
                    <div class="form-group">
                        <label for="edit_reason">Reason</label>
                        <input type="text" id="edit_reason" placeholder="Updated reason">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="warning-btn" onclick="updateBlock()">
                                <i class="fas fa-save"></i> Update
                            </button>
                            <button class="danger-btn" onclick="cancelEdit()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="blocked-dates-table">
                <h4>Currently Blocked Dates</h4>
                <button onclick="fetchBlocks()" style="margin-bottom: 15px;">
                    <i class="fas fa-sync-alt"></i> Refresh Blocks
                </button>
                <div id="blockedDatesLoading" class="loading" style="display: none;">Loading blocked dates...</div>
                <div class="table-wrap">
                    <table id="blockedDatesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Reason</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                    No blocked dates found
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="loadingMessage" class="loading">Loading data from database...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <!-- Dashboard Cards -->
        <div class="dashboard-cards">
            <div class="dashboard-card">
                <h3>Arriving Today</h3>
                <div class="number" id="arrivingToday">0</div>
            </div>
            <div class="dashboard-card">
                <h3>Departing Today</h3>
                <div class="number" id="departingToday">0</div>
            </div>
            <div class="dashboard-card">
                <h3>Weekly Bookings</h3>
                <div class="number" id="weeklyBookings">0</div>
            </div>
            <div class="dashboard-card">
                <h3>Monthly Revenue</h3>
                <div class="number" id="monthlyEstimate">$0</div>
            </div>
        </div>

        <h3>Arriving Today</h3>
        <div class="table-wrap">
            <table id="arrivingTodayTable">
                <thead>
                    <tr>
                        <th>Guest Name</th>
                        <th>Package</th>
                        <th>WhatsApp</th>
                        <th>Arrival Date</th>
                        <th>Departure Date</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h3>Upcoming Bookings</h3>
        <div class="search-container">
            <input type="text" id="upcomingSearch" placeholder="Search upcoming bookings..." />
            <button onclick="filterTable('upcomingTable', document.getElementById('upcomingSearch').value)">Search</button>
            <button onclick="clearSearch('upcomingSearch', 'upcomingTable')">Clear</button>
        </div>
        <div class="table-wrap">
            <table id="upcomingTable">
                <thead>
                    <tr>
                        <th>Guest Name</th>
                        <th>Package</th>
                        <th>WhatsApp</th>
                        <th>Arrival Date</th>
                        <th>Departure Date</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h3>All Bookings</h3>
        <div class="search-container">
            <input type="text" id="allBookingsSearch" placeholder="Search all bookings..." />
            <button onclick="filterTable('allBookingsTable', document.getElementById('allBookingsSearch').value)">Search</button>
            <button onclick="clearSearch('allBookingsSearch', 'allBookingsTable')">Clear</button>
        </div>
        <div class="table-wrap">
            <table id="allBookingsTable">
                <thead>
                    <tr>
                        <th>Guest Name</th>
                        <th>Package</th>
                        <th>WhatsApp</th>
                        <th>Arrival Date</th>
                        <th>Departure Date</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operation completed successfully!</span>
    </div>

    <script>
        // Check authentication
        if (!sessionStorage.getItem('adminAuthenticated')) {
            window.location.href = 'admin-login.html';
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            window.location.href = 'admin-login.html';
        }

        // APIs
        const BOOKING_API = "https://script.google.com/macros/s/AKfycbycehH5GfUKtJbB1wmGSCb8Wmx8Z6unUM_OaeKSUh67bH_6obgZgZEF3fkmuIjViy_G/exec";
        const BLOCK_API = "https://script.google.com/macros/s/AKfycbykBLoTipqGHregVixPiGFm1yLMiUiwj-fEMMYOCbmYA8GeNSk0dCCiI9ts6U0WyJoMkg/exec";

        // Date Blocker Functions
        function toggleDateBlocker() {
            const widget = document.getElementById('dateBlockerWidget');
            widget.classList.toggle('active');
            if (widget.classList.contains('active')) {
                fetchBlocks();
            }
        }

        function showBlockedDatesLoading(show) {
            document.getElementById('blockedDatesLoading').style.display = show ? 'block' : 'none';
        }

        function addBlock() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;
            const reason = document.getElementById("reason").value;

            if (!start || !end || !reason) {
                showToast('Please fill in all fields', true);
                return;
            }

            if (new Date(start) > new Date(end)) {
                showToast('Start date cannot be after end date', true);
                return;
            }

            showBlockedDatesLoading(true);

            fetch(BLOCK_API, {
                method: "POST",
                body: JSON.stringify({
                    action: "create",
                    start: start,
                    end: end,
                    reason: reason
                })
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    showToast('Date range blocked successfully!');
                    document.getElementById("start").value = '';
                    document.getElementById("end").value = '';
                    document.getElementById("reason").value = '';
                    fetchBlocks();
                } else {
                    showToast('Error: ' + (d.message || 'Failed to block dates'), true);
                }
            })
            .catch(err => {
                console.error('Error adding block:', err);
                showToast('Error: Failed to connect to server', true);
            })
            .finally(() => {
                showBlockedDatesLoading(false);
            });
        }

        function fetchBlocks() {
            showBlockedDatesLoading(true);

            fetch(BLOCK_API + '?t=' + new Date().getTime())
            .then(r => r.json())
            .then(data => {
                renderBlockedDatesTable(data);
            })
            .catch(err => {
                console.error('Error fetching blocks:', err);
                showToast('Error loading blocked dates: ' + err.message, true);
                renderBlockedDatesTable([]);
            })
            .finally(() => {
                showBlockedDatesLoading(false);
            });
        }

        function renderBlockedDatesTable(data) {
            const tbody = document.querySelector("#blockedDatesTable tbody");
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            No blocked dates found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = "";
            data.forEach(row => {
                const id = row.ID || row.id;
                const start = row.Start || row.start;
                const end = row.End || row.end;
                const reason = row.Reason || row.reason;
                const timestamp = row.Timestamp || row.timestamp;

                html += `<tr>
                    <td>${id}</td>
                    <td>${formatDisplayDate(start)}</td>
                    <td>${formatDisplayDate(end)}</td>
                    <td>${reason || 'No reason provided'}</td>
                    <td>${formatTimestamp(timestamp)}</td>
                    <td class="action-cell">
                        <button class="action-btn edit-btn" onclick="editBlock('${id}', '${start}', '${end}', '${reason}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteBlockById('${id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function editBlock(id, start, end, reason) {
            document.getElementById("edit_id").value = id;
            document.getElementById("edit_start").value = start;
            document.getElementById("edit_end").value = end;
            document.getElementById("edit_reason").value = reason || '';
            
            document.getElementById("editForm").classList.add("active");
            
            // Scroll to edit form
            document.getElementById("editForm").scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById("editForm").classList.remove("active");
            document.getElementById("edit_id").value = '';
            document.getElementById("edit_start").value = '';
            document.getElementById("edit_end").value = '';
            document.getElementById("edit_reason").value = '';
        }

        function updateBlock() {
            const id = document.getElementById("edit_id").value;
            const start = document.getElementById("edit_start").value;
            const end = document.getElementById("edit_end").value;
            const reason = document.getElementById("edit_reason").value;

            if (!id) {
                showToast('No block selected for editing', true);
                return;
            }

            if (!start || !end || !reason) {
                showToast('Please fill in all fields', true);
                return;
            }

            if (new Date(start) > new Date(end)) {
                showToast('Start date cannot be after end date', true);
                return;
            }

            showBlockedDatesLoading(true);

            fetch(BLOCK_API, {
                method: "POST",
                body: JSON.stringify({
                    action: "update",
                    id: id,
                    start: start,
                    end: end,
                    reason: reason
                })
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    showToast('Block updated successfully!');
                    cancelEdit();
                    fetchBlocks();
                } else {
                    showToast('Error: ' + (d.message || 'Failed to update block'), true);
                }
            })
            .catch(err => {
                console.error('Error updating block:', err);
                showToast('Error: Failed to connect to server', true);
            })
            .finally(() => {
                showBlockedDatesLoading(false);
            });
        }

        function deleteBlockById(id) {
            if (!confirm('Are you sure you want to delete this block?')) {
                return;
            }

            showBlockedDatesLoading(true);

            fetch(BLOCK_API, {
                method: "POST",
                body: JSON.stringify({
                    action: "delete",
                    id: id
                })
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    showToast('Block deleted successfully!');
                    fetchBlocks();
                } else {
                    showToast('Error: ' + (d.message || 'Failed to delete block'), true);
                }
            })
            .catch(err => {
                console.error('Error deleting block:', err);
                showToast('Error: Failed to connect to server', true);
            })
            .finally(() => {
                showBlockedDatesLoading(false);
            });
        }

        function formatDisplayDate(dateStr) {
            if (!dateStr) return 'Invalid Date';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Original Booking Dashboard Functions
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminData();
        });

        async function loadAdminData() {
            showLoading(true);
            hideError();
            
            try {
                console.log('Fetching data from:', BOOKING_API);
                
                const response = await fetch(BOOKING_API + '?t=' + new Date().getTime());
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data);
                
                if (Array.isArray(data)) {
                    updateDashboard(data);
                    renderTables(data);
                    setupSearch();
                    showLoading(false);
                } else {
                    throw new Error('Invalid data format received from server');
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
                showError('Failed to load data: ' + error.message);
                showLoading(false);
            }
        }

        function updateDashboard(bookings) {
            const today = new Date();
            today.setHours(0,0,0,0);

            function parseDate(dateStr) {
                if (!dateStr) return null;
                
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) return date;
                
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const americanDate = new Date(parts[2], parts[0] - 1, parts[1]);
                    if (!isNaN(americanDate.getTime())) return americanDate;
                }
                
                const parts2 = dateStr.split('-');
                if (parts2.length === 3) {
                    const euroDate = new Date(parts2[2], parts2[1] - 1, parts2[0]);
                    if (!isNaN(euroDate.getTime())) return euroDate;
                }
                
                return null;
            }

            const arrivingToday = bookings.filter(booking => {
                const arrivalDate = parseDate(
                    booking['Arrival Date'] || 
                    booking['Arrival date'] || 
                    booking['Arrival date '] ||
                    booking['arrival_date'] ||
                    booking.arrival_date
                );
                return arrivalDate && arrivalDate.getTime() === today.getTime();
            });

            const departingToday = bookings.filter(booking => {
                const departureDate = parseDate(
                    booking['Departure Date'] || 
                    booking['Departure date'] || 
                    booking['Departure date '] ||
                    booking['departure_date'] ||
                    booking.departure_date
                );
                return departureDate && departureDate.getTime() === today.getTime();
            });

            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            const weeklyBookings = bookings.filter(booking => {
                const arrivalDate = parseDate(
                    booking['Arrival Date'] || 
                    booking['Arrival date'] || 
                    booking['Arrival date '] ||
                    booking['arrival_date'] ||
                    booking.arrival_date
                );
                return arrivalDate && arrivalDate >= today && arrivalDate <= nextWeek;
            });

            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthlyEstimate = bookings
                .filter(booking => {
                    const departureDate = parseDate(
                        booking['Departure Date'] || 
                        booking['Departure date'] || 
                        booking['Departure date '] ||
                        booking['departure_date'] ||
                        booking.departure_date
                    );
                    return departureDate && departureDate >= firstDayOfMonth && departureDate <= today;
                })
                .reduce((total, booking) => {
                    const priceStr = booking['Price'] || booking['price'] || '0';
                    const price = parseFloat(priceStr.toString().replace('$', '').replace(',', '')) || 0;
                    return total + price;
                }, 0);

            document.getElementById('arrivingToday').textContent = arrivingToday.length;
            document.getElementById('departingToday').textContent = departingToday.length;
            document.getElementById('weeklyBookings').textContent = weeklyBookings.length;
            document.getElementById('monthlyEstimate').textContent = '$' + monthlyEstimate.toFixed(0);

            renderTable('arrivingTodayTable', arrivingToday);
        }

        function renderTables(bookings) {
            const now = new Date();
            
            const upcoming = bookings
                .filter(booking => {
                    const arrivalDate = parseDateFromBooking(booking, 'arrival');
                    return arrivalDate && arrivalDate >= now;
                })
                .sort((a, b) => {
                    const dateA = parseDateFromBooking(a, 'arrival');
                    const dateB = parseDateFromBooking(b, 'arrival');
                    return dateA - dateB;
                });

            renderTable('upcomingTable', upcoming);
            renderTable('allBookingsTable', bookings);
        }

        function renderTable(tableId, data) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (!tbody) {
                console.error('Table body not found for:', tableId);
                return;
            }
            
            tbody.innerHTML = '';

            if (data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" style="text-align: center; padding: 20px; color: #666;">No bookings found</td>`;
                tbody.appendChild(tr);
                return;
            }

            data.forEach(booking => {
                const phone = 
                    booking['Whatsapp/ Phone ( with country code )'] || 
                    booking['WhatsApp / Phone'] || 
                    booking['WhatsApp / Phone '] ||
                    booking['phone'] ||
                    booking.phone ||
                    '';

                const guestName = 
                    booking['Guest Name'] || 
                    booking['Guest'] || 
                    booking['guest_name'] ||
                    booking.guest_name ||
                    '';

                const retreatPackage = 
                    booking['Retreat Package'] || 
                    booking['Retreat Package '] || 
                    booking['package'] ||
                    booking.package ||
                    '';

                const price = 
                    booking['Price'] || 
                    booking['price'] || 
                    '';

                const arrivalDate = formatDate(parseDateFromBooking(booking, 'arrival'));
                const departureDate = formatDate(parseDateFromBooking(booking, 'departure'));

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${guestName}</td>
                    <td>${retreatPackage}</td>
                    <td>${phone ? `<a class="whatsapp-link" href="${phone}" target="_blank" rel="noopener">WhatsApp</a>` : 'N/A'}</td>
                    <td>${arrivalDate}</td>
                    <td>${departureDate}</td>
                    <td>${price}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function parseDateFromBooking(booking, type) {
            if (type === 'arrival') {
                return parseDate(
                    booking['Arrival Date'] || 
                    booking['Arrival date'] || 
                    booking['Arrival date '] ||
                    booking['arrival_date'] ||
                    booking.arrival_date
                );
            } else {
                return parseDate(
                    booking['Departure Date'] || 
                    booking['Departure date'] || 
                    booking['Departure date '] ||
                    booking['departure_date'] ||
                    booking.departure_date
                );
            }
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) return date;
            
            const formats = [
                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,
                /^(\d{1,2})-(\d{1,2})-(\d{4})$/,
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/
            ];
            
            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    let year, month, day;
                    
                    if (format === formats[0]) {
                        month = parseInt(match[1]) - 1;
                        day = parseInt(match[2]);
                        year = parseInt(match[3]);
                    } else if (format === formats[1]) {
                        day = parseInt(match[1]);
                        month = parseInt(match[2]) - 1;
                        year = parseInt(match[3]);
                    } else {
                        year = parseInt(match[1]);
                        month = parseInt(match[2]) - 1;
                        day = parseInt(match[3]);
                    }
                    
                    const parsedDate = new Date(year, month, day);
                    if (!isNaN(parsedDate.getTime())) return parsedDate;
                }
            }
            
            return null;
        }

        function formatDate(date) {
            if (!date) return 'Invalid Date';
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function setupSearch() {
            document.getElementById('upcomingSearch').addEventListener('input', function() {
                filterTable('upcomingTable', this.value);
            });
            document.getElementById('allBookingsSearch').addEventListener('input', function() {
                filterTable('allBookingsTable', this.value);
            });
        }

        function filterTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }

        function clearSearch(inputId, tableId) {
            document.getElementById(inputId).value = '';
            filterTable(tableId, '');
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.className = isError ? 'toast error show' : 'toast show';

            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
    </script>
</body>
</html>